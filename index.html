<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SDR Performance — L-Team Summary — Q1 FY26</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', -apple-system, sans-serif; background: #f8fafc; color: #0f172a; }
  .dashboard { max-width: 1200px; margin: 0 auto; padding: 24px; }

  .dash-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 24px; border-bottom: 3px solid #0F4C81; padding-bottom: 16px; }
  .dash-title { font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; }
  .dash-h1 { font-size: 26px; font-weight: 800; color: #0F4C81; margin-top: 2px; }
  .dash-meta { text-align: right; font-size: 12px; color: #64748b; line-height: 1.6; }
  .dash-meta strong { color: #0f172a; }

  .section { margin-bottom: 24px; }
  .section-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .section-title { font-size: 15px; font-weight: 700; color: #0F4C81; border-left: 4px solid #0F4C81; padding-left: 10px; }
  .section-sub { font-size: 11px; color: #94a3b8; }

  .kpi-row { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
  .kpi { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px 16px; position: relative; display: flex; flex-direction: column; }
  .kpi::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; border-radius: 10px 10px 0 0; }
  .kpi.green::before { background: #16a34a; } .kpi.amber::before { background: #d97706; }
  .kpi.red::before { background: #dc2626; } .kpi.blue::before { background: #0F4C81; }
  .kpi.purple::before { background: #7B2D8E; } .kpi.orange::before { background: #F18F01; }
  .kpi.grey::before { background: #94a3b8; }
  .kpi-label { font-size: 10px; color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
  .kpi-arrow { position: absolute; top: 14px; right: 10px; display: flex; align-items: center; gap: 3px; }
  .kpi-value { font-size: 26px; font-weight: 800; margin: 4px 0 2px; }
  .kpi-target { font-size: 11px; color: #64748b; flex: 1; }
  .kpi-delta { font-size: 11px; font-weight: 600; margin-top: 6px; padding: 2px 6px; border-radius: 4px; display: inline-block; align-self: flex-start; }
  .kpi-delta.up { background: #f0fdf4; color: #16a34a; } .kpi-delta.down { background: #fef2f2; color: #dc2626; }
  .kpi-delta.flat { background: #f1f5f9; color: #64748b; } .kpi-delta.amber { background: #fffbeb; color: #d97706; }

  .wow-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
  .wow-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px 16px; }
  .wow-card-title { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 6px; }
  .wow-main { font-size: 22px; font-weight: 800; }
  .wow-detail { font-size: 11px; color: #64748b; margin-top: 4px; line-height: 1.5; }
  .wow-tag { font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 4px; }
  .wow-tag.pos { background: #f0fdf4; color: #16a34a; } .wow-tag.neg { background: #fef2f2; color: #dc2626; } .wow-tag.neu { background: #f1f5f9; color: #64748b; }

  .trend-tag { display: inline-flex; align-items: center; gap: 3px; font-size: 10px; font-weight: 600; padding: 2px 7px; border-radius: 4px; }
  .trend-tag.up { background: #f0fdf4; color: #16a34a; }
  .trend-tag.down { background: #fef2f2; color: #dc2626; }
  .trend-tag.flat { background: #f1f5f9; color: #64748b; }
  .zone-tip { display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; border-radius: 50%; background: #e2e8f0; color: #64748b; font-size: 9px; font-weight: 700; cursor: help; margin-left: 4px; vertical-align: middle; position: relative; }
  .zone-tip:hover::after { content: attr(data-tip); position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%); background: #0f172a; color: #fff; font-size: 10px; font-weight: 400; padding: 6px 10px; border-radius: 6px; white-space: normal; width: 220px; z-index: 10; pointer-events: none; line-height: 1.4; }

  /* Pipeline vs Target bars */
  .pipe-target-section { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px 18px; }
  .pipe-target-title { font-size: 13px; font-weight: 800; color: #0f172a; margin-bottom: 1px; }
  .pipe-target-sub { font-size: 10px; color: #94a3b8; margin-bottom: 10px; }
  .pipe-bar-row { display: grid; grid-template-columns: 120px 70px 1fr 100px 48px 42px; align-items: center; gap: 0; padding: 7px 0; border-top: 1px solid #f1f5f9; }
  .pipe-bar-row:first-of-type { border-top: none; }
  .pipe-bar-row.global-row { background: #f8fafc; border-radius: 6px; padding: 8px 10px; margin: 0 -10px 4px; border-top: none; }
  .pipe-bar-label { display: flex; align-items: center; gap: 6px; }
  .pipe-bar-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .pipe-bar-name { font-size: 12px; font-weight: 700; color: #0f172a; }
  .pipe-bar-value { font-size: 13px; font-weight: 800; color: #0f172a; text-align: right; padding-right: 12px; }
  .pipe-bar-track { position: relative; height: 20px; background: #e8edf3; border-radius: 4px; overflow: visible; }
  .pipe-bar-fill { height: 100%; border-radius: 4px; min-width: 2px; transition: width 0.4s; }
  .pipe-bar-target-line { position: absolute; top: -3px; bottom: -3px; width: 2px; background: #475569; z-index: 2; }
  .pipe-bar-target-label { font-size: 10px; color: #64748b; text-align: right; padding-left: 6px; }
  .pipe-bar-pct { font-size: 13px; font-weight: 800; text-align: right; padding-left: 4px; padding-right: 4px; }
  .pipe-bar-pct.green { color: #16a34a; } .pipe-bar-pct.amber { color: #d97706; } .pipe-bar-pct.red { color: #dc2626; }
  .pipe-bar-footer { font-size: 9px; color: #94a3b8; font-style: italic; margin-top: 8px; line-height: 1.4; }

  /* Trend chart */
  .chart-container { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 20px; }
  .chart-area { width: 100%; position: relative; }
  canvas { width: 100%; height: 100%; }

  .dash-footer { margin-top: 24px; padding-top: 12px; border-top: 1px solid #e2e8f0; font-size: 10px; color: #94a3b8; display: flex; justify-content: space-between; }

  @media print { body { background: #fff; } .dashboard { padding: 12px; } }
  @media (max-width: 768px) { .kpi-row { grid-template-columns: repeat(2, 1fr); } .wow-grid { grid-template-columns: repeat(2, 1fr); } .pipe-bar-row { grid-template-columns: 100px 70px 1fr 90px 50px 38px; } }
</style>
</head>
<body>
<div class="dashboard">

  <div class="dash-header">
    <div>
      <div class="dash-title">Sales Development Organisation</div>
      <div class="dash-h1">L-Team Performance Summary</div>
    </div>
    <div class="dash-meta">
      <div><strong>Q1 FY26</strong> · Week 6 ending 12 February 2026</div>
      <div>6 of 13 weeks elapsed (46%)</div>
      <div>28 of 43 target SDRs active (65%)</div>
    </div>
  </div>

  <!-- 1. GLOBAL KPIs -->
  <div class="section">
    <div class="section-head"><div class="section-title">Global Headlines</div><div class="section-sub">All business units combined</div></div>
    <div class="kpi-row" id="globalKpis"></div>
  </div>

  <!-- 2. WEEK-ON-WEEK CHANGES -->
  <div class="section">
    <div class="section-head"><div class="section-title">Week-on-Week Changes</div><div class="section-sub" id="wowSub"></div></div>
    <div class="wow-grid" id="wowGrid"></div>
  </div>

  <!-- 3. PIPELINE vs PRO-RATED TARGET -->
  <div class="section">
    <div class="section-head"><div class="section-title">Pipeline vs Pro-rated Target</div><div class="section-sub">Cumulative pipeline against time-adjusted quarterly targets</div></div>
    <div class="pipe-target-section" id="pipeTargetBars"></div>
  </div>

  <!-- 4. PIPELINE TREND -->
  <div class="section">
    <div class="section-head"><div class="section-title">Pipeline Trajectory</div><div class="section-sub">Cumulative pipeline with pace and required projections to Q1 end</div></div>
    <div id="trendCallout"></div>
    <div class="chart-container" style="margin-top:10px">
      <div style="font-size:12px;font-weight:700;color:#0F4C81;margin-bottom:4px" id="trendTitle">Pipeline Trend — Global</div>
      <div style="font-size:10px;color:#94a3b8;margin-bottom:12px">Dashed grey = pro-rated target curve · Solid green = cumulative actuals · Solid navy = required pace to target</div>
      <div class="chart-area" style="height:440px"><canvas id="trendCanvas"></canvas></div>
    </div>
  </div>

  <div class="dash-footer">
    <div>Prepared by SDR Leadership · Source: Salesloft + Salesforce + FY26 Comp Plan · Data as of 12 Feb 2026</div>
    <div>L-Team Summary · Confidential</div>
  </div>
</div>

<script>
// ============================================================
// CORE DATA — copied from operational dashboard
// ============================================================
const WEEK = { ending: '2026-02-12', number: 6, weeksElapsed: 6, totalWeeks: 13, weeksRemaining: 7 };

const BU_META = {
  DACH_ENT_OB: { label: 'DACH Enterprise Outbound', color: '#0F4C81', hcTarget: 6 },
  DACH_CORP_OB:{ label: 'DACH Corporate Outbound', color: '#2563eb', hcTarget: 5 },
  EMEA_OB:  { label: 'EMEA Outbound', color: '#F18F01', hcTarget: 7 },
  AMER_OB:  { label: 'AMER Outbound', color: '#7B2D8E', hcTarget: 7 },
  APJ_OB:   { label: 'APJ Outbound', color: '#C73E1D', hcTarget: 8 },
  INBOUND:  { label: 'Inbound', color: '#64748b', hcTarget: 10 },
};

const MONTHLY_PIPE_TARGETS = {
  'Malvina Muraccioli': { jan:100000, feb:130000, mar:150000 },
  'Loic Hermabessiere': { jan:100000, feb:130000, mar:150000 },
  'Marva Hakimi':       { jan:50000,  feb:97000,  mar:150000 },
  'Casey Arra':         { jan:38000,  feb:73000,  mar:112000 },
  'Matthew Salisbury':  { jan:75000,  feb:130000, mar:150000 },
  'Johannes Hounsgaard':{ jan:130000, feb:168000, mar:194000 },
  'Lucas Durst':        { jan:130000, feb:168000, mar:194000 },
  'Burak Ayten':        { jan:130000, feb:168000, mar:194000 },
  'Julian Spretz':      { jan:130000, feb:168000, mar:194000 },
  'Armin Oesterwind':   { jan:130000, feb:168000, mar:194000 },
  'Julia Laura Damrath':{ jan:0,      feb:84000,  mar:146000 },
  'Fabio Ferrauti':     { jan:100000, feb:130000, mar:150000 },
  'Philip Croes':       { jan:100000, feb:130000, mar:150000 },
  'Giulio Sudano':      { jan:50000,  feb:97000,  mar:150000 },
  'Salma Geaissa':      { jan:0,      feb:65000,  mar:112000 },
  'Andrew Moher':       { jan:99466,  feb:143967, mar:182889 },
  'Tyler Escamilla':    { jan:114466, feb:162967, mar:204889 },
  'Richard Lam':        { jan:99466,  feb:143967, mar:182889 },
  'Gracie Haskell':     { jan:57233,  feb:122725, mar:204889 },
  'Ryuya Tanida':       { jan:136274, feb:176657, mar:203911 },
  'Chisako Nukui':      { jan:161274, feb:209657, mar:241911 },
  'Kai Nakamichi':      { jan:161274, feb:209657, mar:241911 },
  'Kaho Mizumachi':     { jan:136274, feb:176657, mar:203911 },
  'Sho Nakazawa':       { jan:161274, feb:209657, mar:241911 },
  'Kelly Sito':         { jan:0,      feb:0,      mar:0 },
  'Lucas Schmalzl':     { jan:187000, feb:243000, mar:280000 },
  'Oisin Flynn':        { jan:204000, feb:265000, mar:306000 },
  'Ying Hong':          { jan:125000, feb:243000, mar:373000 },
  'Claire Gilpatrick':  { jan:0,      feb:0,      mar:34000 },
  'Mayuko Ogisu':       { jan:0,      feb:0,      mar:0 },
};

const MONTHLY_SAO_TARGETS = {
  'Malvina Muraccioli': { jan:8,  feb:10, mar:12 },
  'Loic Hermabessiere': { jan:6,  feb:8,  mar:9 },
  'Marva Hakimi':       { jan:4,  feb:6,  mar:9 },
  'Casey Arra':         { jan:3,  feb:6,  mar:9 },
  'Matthew Salisbury':  { jan:4,  feb:8,  mar:9 },
  'Johannes Hounsgaard':{ jan:6,  feb:8,  mar:9 },
  'Lucas Durst':        { jan:6,  feb:8,  mar:9 },
  'Burak Ayten':        { jan:6,  feb:8,  mar:9 },
  'Julian Spretz':      { jan:6,  feb:8,  mar:9 },
  'Armin Oesterwind':   { jan:6,  feb:8,  mar:9 },
  'Julia Laura Damrath':{ jan:0,  feb:4,  mar:7 },
  'Fabio Ferrauti':     { jan:7,  feb:9,  mar:10 },
  'Philip Croes':       { jan:7,  feb:9,  mar:10 },
  'Giulio Sudano':      { jan:3,  feb:6,  mar:10 },
  'Salma Geaissa':      { jan:0,  feb:4,  mar:7 },
  'Andrew Moher':       { jan:9,  feb:13, mar:17 },
  'Tyler Escamilla':    { jan:10, feb:15, mar:18 },
  'Richard Lam':        { jan:9,  feb:13, mar:17 },
  'Gracie Haskell':     { jan:5,  feb:11, mar:18 },
  'Ryuya Tanida':       { jan:11, feb:15, mar:17 },
  'Chisako Nukui':      { jan:13, feb:17, mar:20 },
  'Kai Nakamichi':      { jan:13, feb:17, mar:20 },
  'Kaho Mizumachi':     { jan:11, feb:15, mar:17 },
  'Sho Nakazawa':       { jan:13, feb:17, mar:20 },
  'Kelly Sito':         { jan:0,  feb:0,  mar:0 },
  'Lucas Schmalzl':     { jan:11, feb:14, mar:17 },
  'Oisin Flynn':        { jan:13, feb:16, mar:19 },
  'Ying Hong':          { jan:7,  feb:14, mar:21 },
  'Claire Gilpatrick':  { jan:0,  feb:0,  mar:4 },
  'Mayuko Ogisu':       { jan:0,  feb:0,  mar:0 },
};

const SDR_ROSTER = {
  'Malvina Muraccioli': { bu:'EMEA_OB', region:'EMEA', mgr:'Julien', seg:'CORP' },
  'Loic Hermabessiere': { bu:'EMEA_OB', region:'EMEA', mgr:'Julien', seg:'ENT' },
  'Marva Hakimi':       { bu:'EMEA_OB', region:'EMEA', mgr:'Julien', seg:'ENT' },
  'Casey Arra':         { bu:'EMEA_OB', region:'EMEA', mgr:'Julien', seg:'CORP' },
  'Matthew Salisbury':  { bu:'EMEA_OB', region:'EMEA', mgr:'Julien', seg:'ENT' },
  'Johannes Hounsgaard':{ bu:'DACH_ENT_OB', region:'DACH', mgr:'David Perl', seg:'ENT' },
  'Lucas Durst':        { bu:'DACH_ENT_OB', region:'DACH', mgr:'David Perl', seg:'ENT' },
  'Burak Ayten':        { bu:'DACH_ENT_OB', region:'DACH', mgr:'David Perl', seg:'ENT' },
  'Julian Spretz':      { bu:'DACH_ENT_OB', region:'DACH', mgr:'David Perl', seg:'ENT' },
  'Armin Oesterwind':   { bu:'DACH_ENT_OB', region:'DACH', mgr:'David Perl', seg:'ENT' },
  'Julia Laura Damrath':{ bu:'DACH_ENT_OB', region:'DACH', mgr:'David Perl', seg:'ENT' },
  'Fabio Ferrauti':     { bu:'DACH_CORP_OB', region:'DACH', mgr:'Patricia', seg:'CORP' },
  'Philip Croes':       { bu:'DACH_CORP_OB', region:'DACH', mgr:'Patricia', seg:'CORP' },
  'Giulio Sudano':      { bu:'DACH_CORP_OB', region:'DACH', mgr:'Patricia', seg:'CORP' },
  'Salma Geaissa':      { bu:'DACH_CORP_OB', region:'DACH', mgr:'Patricia', seg:'CORP' },
  'Andrew Moher':       { bu:'AMER_OB', region:'AMER', mgr:'Woojin', seg:'CORP' },
  'Tyler Escamilla':    { bu:'AMER_OB', region:'AMER', mgr:'Woojin', seg:'ENT' },
  'Richard Lam':        { bu:'AMER_OB', region:'AMER', mgr:'Woojin', seg:'CORP' },
  'Gracie Haskell':     { bu:'AMER_OB', region:'AMER', mgr:'Woojin', seg:'ENT' },
  'Claire Gilpatrick':  { bu:'AMER_OB', region:'AMER', mgr:'Woojin', seg:'CORP' },
  'Ryuya Tanida':       { bu:'APJ_OB', region:'APJ', mgr:'Rio', seg:'CORP' },
  'Chisako Nukui':      { bu:'APJ_OB', region:'APJ', mgr:'Rio', seg:'ENT' },
  'Kai Nakamichi':      { bu:'APJ_OB', region:'APJ', mgr:'Rio', seg:'ENT' },
  'Kaho Mizumachi':     { bu:'APJ_OB', region:'APJ', mgr:'Rio', seg:'CORP' },
  'Sho Nakazawa':       { bu:'APJ_OB', region:'APJ', mgr:'Rio', seg:'ENT' },
  'Kelly Sito':         { bu:'APJ_OB', region:'APJ', mgr:'Rio', seg:'ENT' },
  'Mayuko Ogisu':       { bu:'APJ_OB', region:'APJ', mgr:'Rio', seg:'CORP' },
  'Lucas Schmalzl':     { bu:'INBOUND', region:'DACH', mgr:'Andy', seg:'All' },
  'Oisin Flynn':        { bu:'INBOUND', region:'EMEA', mgr:'Andy', seg:'All' },
  'Ying Hong':          { bu:'INBOUND', region:'DACH', mgr:'Andy', seg:'All' },
};

const SDRS = [
  { name:'Malvina Muraccioli', acts:15000, saos:29, pipe:382000 },
  { name:'Loic Hermabessiere', acts:2100,  saos:11, pipe:179000 },
  { name:'Marva Hakimi',       acts:6400,  saos:10, pipe:264000 },
  { name:'Casey Arra',         acts:2300,  saos:3,  pipe:35000 },
  { name:'Matthew Salisbury',  acts:1000,  saos:1,  pipe:76000 },
  { name:'Johannes Hounsgaard',acts:1400,  saos:13, pipe:230000 },
  { name:'Lucas Durst',        acts:1400,  saos:9,  pipe:205000 },
  { name:'Burak Ayten',        acts:2500,  saos:4,  pipe:79000 },
  { name:'Julian Spretz',      acts:994,   saos:3,  pipe:29000 },
  { name:'Armin Oesterwind',   acts:874,   saos:1,  pipe:17000 },
  { name:'Julia Laura Damrath',acts:59,    saos:3,  pipe:34000 },
  { name:'Fabio Ferrauti',     acts:736,   saos:6,  pipe:91000 },
  { name:'Philip Croes',       acts:557,   saos:5,  pipe:91000 },
  { name:'Giulio Sudano',      acts:476,   saos:0,  pipe:0 },
  { name:'Salma Geaissa',      acts:142,   saos:0,  pipe:0 },
  { name:'Andrew Moher',       acts:1800,  saos:15, pipe:88000 },
  { name:'Tyler Escamilla',    acts:1300,  saos:13, pipe:380000 },
  { name:'Richard Lam',        acts:1500,  saos:9,  pipe:28000 },
  { name:'Gracie Haskell',     acts:4000,  saos:4,  pipe:32000 },
  { name:'Ryuya Tanida',       acts:6100,  saos:30, pipe:399000 },
  { name:'Chisako Nukui',      acts:7000,  saos:21, pipe:257000 },
  { name:'Kai Nakamichi',      acts:4500,  saos:17, pipe:210000 },
  { name:'Kaho Mizumachi',     acts:2100,  saos:11, pipe:42000 },
  { name:'Sho Nakazawa',       acts:1200,  saos:15, pipe:135000 },
  { name:'Kelly Sito',         acts:369,   saos:0,  pipe:0 },
  { name:'Lucas Schmalzl',     acts:3400,  saos:32, pipe:260000 },
  { name:'Oisin Flynn',        acts:9500,  saos:8,  pipe:125000 },
  { name:'Ying Hong',          acts:3200,  saos:4,  pipe:13000 },
];

SDRS.forEach(s => {
  const r = SDR_ROSTER[s.name];
  if (r) { s.bu = r.bu; s.region = r.region; s.mgr = r.mgr; s.seg = r.seg; }
});

const LAST_WEEK_ACTS = {
  'Andrew Moher': 457, 'Armin Oesterwind': 6, 'Burak Ayten': 682,
  'Casey Arra': 411, 'Chisako Nukui': 847, 'Fabio Ferrauti': 132,
  'Giulio Sudano': 130, 'Gracie Haskell': 860, 'Johannes Hounsgaard': 302,
  'Julia Laura Damrath': 33, 'Julian Spretz': 581, 'Kaho Mizumachi': 506,
  'Kai Nakamichi': 552, 'Kelly Sito': 366, 'Loic Hermabessiere': 460, 'Lucas Durst': 476,
  'Lucas Schmalzl': 104, 'Malvina Muraccioli': 2100, 'Marva Hakimi': 1200,
  'Matthew Salisbury': 303, 'Oisin Flynn': 2200, 'Philip Croes': 70,
  'Richard Lam': 305, 'Ryuya Tanida': 877, 'Salma Geaissa': 95,
  'Sho Nakazawa': 486, 'Tyler Escamilla': 111, 'Ying Hong': 68,
};

const PREV_WEEK = {
  totalPipe: 3089795, totalSAOs: 208, totalActs: 64474,
  activeSDRs: 27, onTrack: 11,
  zoneActivity: 3, zoneConversion: 4, zoneDealSize: 0,
  zoneOnTrack: 7, zoneExceeding: 5, zoneRamping: 8,
};

const WEEKS_DEF = [
  { n:1,  ending:'2026-01-08' }, { n:2,  ending:'2026-01-15' },
  { n:3,  ending:'2026-01-22' }, { n:4,  ending:'2026-01-29' },
  { n:5,  ending:'2026-02-05' }, { n:6,  ending:'2026-02-12' },
  { n:7,  ending:'2026-02-19' }, { n:8,  ending:'2026-02-26' },
  { n:9,  ending:'2026-03-05' }, { n:10, ending:'2026-03-12' },
  { n:11, ending:'2026-03-19' }, { n:12, ending:'2026-03-26' },
  { n:13, ending:'2026-03-31' },
];

const WEEK_HISTORY = [
  { week:1, EMEA_OB:{pipe:63695,saos:7}, DACH_ENT_OB:{pipe:49000,saos:4}, DACH_CORP_OB:{pipe:6700,saos:1},
    AMER_OB:{pipe:4700,saos:2}, APJ_OB:{pipe:224500,saos:15}, INBOUND:{pipe:17000,saos:3},
    IB_DACH:{pipe:14000,saos:1}, IB_EMEA:{pipe:3000,saos:2} },
  { week:2, EMEA_OB:{pipe:421695,saos:21}, DACH_ENT_OB:{pipe:262000,saos:11}, DACH_CORP_OB:{pipe:10900,saos:2},
    AMER_OB:{pipe:99700,saos:14}, APJ_OB:{pipe:323600,saos:22}, INBOUND:{pipe:87000,saos:12},
    IB_DACH:{pipe:84000,saos:10}, IB_EMEA:{pipe:3000,saos:2} },
  { week:3, EMEA_OB:{pipe:604695,saos:33}, DACH_ENT_OB:{pipe:319600,saos:15}, DACH_CORP_OB:{pipe:39700,saos:5},
    AMER_OB:{pipe:111500,saos:18}, APJ_OB:{pipe:464400,saos:37}, INBOUND:{pipe:172000,saos:19},
    IB_DACH:{pipe:169000,saos:17}, IB_EMEA:{pipe:3000,saos:2} },
  { week:4, EMEA_OB:{pipe:604695,saos:33}, DACH_ENT_OB:{pipe:330600,saos:17}, DACH_CORP_OB:{pipe:39700,saos:5},
    AMER_OB:{pipe:582500,saos:24}, APJ_OB:{pipe:533000,saos:44}, INBOUND:{pipe:172000,saos:19},
    IB_DACH:{pipe:169000,saos:17}, IB_EMEA:{pipe:3000,saos:2} },
  { week:5, EMEA_OB:{pipe:707195,saos:42}, DACH_ENT_OB:{pipe:473600,saos:25}, DACH_CORP_OB:{pipe:116700,saos:9},
    AMER_OB:{pipe:712500,saos:31}, APJ_OB:{pipe:846000,saos:72}, INBOUND:{pipe:233800,saos:29},
    IB_DACH:{pipe:205800,saos:24}, IB_EMEA:{pipe:28000,saos:5} },
  { week:6, EMEA_OB:{pipe:993695,saos:59}, DACH_ENT_OB:{pipe:594000,saos:33}, DACH_CORP_OB:{pipe:182000,saos:11},
    AMER_OB:{pipe:972800,saos:45}, APJ_OB:{pipe:1043000,saos:94}, INBOUND:{pipe:398000,saos:44},
    IB_DACH:{pipe:273000,saos:36}, IB_EMEA:{pipe:125000,saos:8} },
];

const SDR_ACT_HISTORY = {
  'Malvina Muraccioli':  [2600,2600,2600,2500,2600,2100],
  'Loic Hermabessiere':  [58,394,664,310,169,460],
  'Marva Hakimi':        [1400,1200,962,507,1100,1200],
  'Casey Arra':          [1,101,384,905,451,411],
  'Matthew Salisbury':   [6,14,305,87,184,303],
  'Johannes Hounsgaard': [111,253,149,3,148,302],
  'Lucas Durst':         [37,175,307,54,280,476],
  'Burak Ayten':         [110,620,361,223,452,682],
  'Julian Spretz':       [124,85,18,8,123,581],
  'Armin Oesterwind':    [360,368,127,5,3,6],
  'Julia Laura Damrath': [0,1,2,0,4,33],
  'Fabio Ferrauti':      [43,399,28,4,121,132],
  'Philip Croes':        [72,266,62,2,88,70],
  'Giulio Sudano':       [62,75,107,64,38,130],
  'Salma Geaissa':       [0,1,0,0,37,95],
  'Andrew Moher':        [315,398,226,88,272,457],
  'Tyler Escamilla':     [202,190,365,175,174,111],
  'Richard Lam':         [385,275,255,155,77,305],
  'Gracie Haskell':      [73,165,579,981,1100,860],
  'Ryuya Tanida':        [348,921,1300,1500,946,877],
  'Chisako Nukui':       [117,574,2300,1600,1500,847],
  'Kai Nakamichi':       [464,1100,642,814,715,552],
  'Kaho Mizumachi':      [2,48,410,593,433,506],
  'Sho Nakazawa':        [46,163,191,45,51,486],
  'Kelly Sito':          [0,0,0,0,0,366],
  'Lucas Schmalzl':      [40,1200,995,435,570,104],
  'Oisin Flynn':         [412,815,2300,1000,2300,2200],
  'Ying Hong':           [15,1100,973,7,957,68],
};

const WE = WEEK.weeksElapsed;
const ALL_BUS = ['EMEA_OB','DACH_ENT_OB','DACH_CORP_OB','AMER_OB','APJ_OB','INBOUND'];
const SNAPSHOT_LATEST = WEEK_HISTORY[WEEK_HISTORY.length - 1];

// ── Snapshot total helper ──
function snapshotTotal(scope) {
  const w = SNAPSHOT_LATEST;
  if (!scope || scope === 'GLOBAL') {
    return { pipe: ALL_BUS.reduce((s,bu) => s + (w[bu]?w[bu].pipe:0), 0),
             saos: ALL_BUS.reduce((s,bu) => s + (w[bu]?w[bu].saos:0), 0) };
  }
  if (scope.startsWith('R_')) {
    const reg = scope.replace('R_','');
    const map = { DACH:['DACH_ENT_OB','DACH_CORP_OB'], EMEA:['EMEA_OB'], AMER:['AMER_OB'], APJ:['APJ_OB'] };
    const bus = map[reg] || [];
    const ibKey = 'IB_' + reg;
    let p = bus.reduce((s,b) => s + (w[b]?w[b].pipe:0), 0) + (w[ibKey]?w[ibKey].pipe:0);
    let sa = bus.reduce((s,b) => s + (w[b]?w[b].saos:0), 0) + (w[ibKey]?w[ibKey].saos:0);
    return { pipe: p, saos: sa };
  }
  return { pipe: w[scope]?w[scope].pipe:0, saos: w[scope]?w[scope].saos:0 };
}

// ── Pro-rate targets ──
(() => {
  const d = new Date(WEEK.ending + 'T00:00:00');
  const month = d.getMonth();
  const day = d.getDate();
  const saoDay = Math.min(day + 2, new Date(d.getFullYear(), month + 1, 0).getDate());
  const daysInMonth = new Date(d.getFullYear(), month + 1, 0).getDate();

  function prorate(t, useDay) {
    if (month === 0)      return Math.round((useDay / daysInMonth) * t.jan);
    else if (month === 1) return Math.round(t.jan + (useDay / daysInMonth) * t.feb);
    else                  return Math.round(t.jan + t.feb + (useDay / daysInMonth) * t.mar);
  }

  SDRS.forEach(s => {
    const pt = MONTHLY_PIPE_TARGETS[s.name];
    if (!pt) { s.pipeTarget = 0; s.pipeQ1 = 0; }
    else { s.pipeQ1 = pt.jan + pt.feb + pt.mar; s.pipeTarget = prorate(pt, day); }
    const st = MONTHLY_SAO_TARGETS[s.name];
    if (!st) { s.saoT = 0; s.saoQ1 = 0; }
    else { s.saoQ1 = st.jan + st.feb + st.mar; s.saoT = prorate(st, saoDay); }
  });
})();

// ── Derived fields ──
SDRS.forEach(s => {
  s.saoPct = s.saoT > 0 ? (s.saos / s.saoT) * 100 : 0;
  s.weekly = s.acts != null ? Math.round(s.acts / WE) : null;
  s.onTrack = s.saoPct >= 75;
  s.pipePct = s.pipeTarget > 0 ? (s.pipe / s.pipeTarget) * 100 : 0;
});

// ── Ramp detection ──
(() => {
  const groups = {};
  SDRS.forEach(s => { const key = s.bu+'|'+s.seg; if(!groups[key]) groups[key]=[]; groups[key].push(s); });
  Object.values(groups).forEach(arr => {
    const mx = Math.max(...arr.map(s => s.pipeTarget));
    arr.forEach(s => { const ratio = mx > 0 ? s.pipeTarget / mx : 1; s.type = [0,0.50,0.75].some(r => Math.abs(ratio-r)<=0.10) ? 'Ramp' : 'Full'; });
  });
})();

// ── Utils ──
function eur(v) { if (v == null) return '—'; return '€' + (v >= 1000000 ? (v/1000000).toFixed(2)+'M' : v >= 1000 ? Math.round(v/1000)+'k' : v); }
function eurShort(v) { if (v == null) return '—'; return '€' + (v >= 1000000 ? (v/1000000).toFixed(1)+'M' : v >= 1000 ? Math.round(v/1000)+'k' : v); }
function pct(v) { return v.toFixed(0) + '%'; }

// ============================================================
// 1. GLOBAL KPIs
// ============================================================
function renderGlobalKPIs() {
  const snap = snapshotTotal('GLOBAL');
  const totalPipe = snap.pipe;
  const totalSAO = snap.saos;
  const totalPipePR = SDRS.reduce((s,d) => s + d.pipeTarget, 0);
  const totalSaoPR = SDRS.reduce((s,d) => s + d.saoT, 0);
  const pA = totalPipePR > 0 ? totalPipe/totalPipePR*100 : 0;
  const sA = totalSaoPR > 0 ? totalSAO/totalSaoPR*100 : 0;
  const active = SDRS.filter(s => s.acts != null).length;
  const avgP = active > 0 ? totalPipe / active : 0;
  const wkVals = SDRS.filter(s => s.weekly != null).map(s => s.weekly).sort((a,b) => a-b);
  const med = wkVals[Math.floor(wkVals.length/2)] || 0;
  const onT = SDRS.filter(s => s.onTrack).length;
  const oR = SDRS.length > 0 ? onT/SDRS.length*100 : 0;

  const qTarget = 430000;
  const proRatedTarget = qTarget * (WE / WEEK.totalWeeks);
  const avgPctOfTarget = proRatedTarget > 0 ? avgP / proRatedTarget * 100 : 0;
  const prevAvgP = PREV_WEEK.totalPipe / (PREV_WEEK.activeSDRs || active);
  const prevProRated = qTarget * ((WE - 1) / WEEK.totalWeeks);
  const prevAvgPct = prevProRated > 0 ? prevAvgP / prevProRated * 100 : 0;

  function kpiArrow(cur, prev, label, suffix, desc, threshold) {
    const t = threshold !== undefined ? threshold : 2;
    const d = cur - prev;
    const dir = d > t ? 'up' : d < -t ? 'down' : 'flat';
    const sym = d > t ? '▲' : d < -t ? '▼' : '▶';
    const move = d > t ? 'Up' : d < -t ? 'Down' : 'Flat';
    const tip = `${label}: ${move} vs last week (${suffix})`;
    return `<span class="trend-tag ${dir}" style="font-size:9px;padding:1px 5px;vertical-align:middle" title="${tip}">${sym}</span><span class="zone-tip" data-tip="${desc}">?</span>`;
  }

  const prevPipeAtt = totalPipePR > 0 ? PREV_WEEK.totalPipe / totalPipePR * 100 : 0;
  const prevSaoAtt = totalSaoPR > 0 ? PREV_WEEK.totalSAOs / totalSaoPR * 100 : 0;
  const prevOnTrackPct = PREV_WEEK.activeSDRs > 0 ? PREV_WEEK.onTrack / PREV_WEEK.activeSDRs * 100 : 0;
  const curOnTrackPct = SDRS.length > 0 ? onT / SDRS.length * 100 : 0;

  const prevWkActs = SDRS.map(s => {
    const h = SDR_ACT_HISTORY[s.name];
    return h && h.length >= 2 ? h[h.length - 2] : null;
  }).filter(v => v != null).sort((a,b) => a - b);
  const prevMed = prevWkActs.length > 0 ? prevWkActs[Math.floor(prevWkActs.length / 2)] : med;

  const pipeArrow = kpiArrow(pA, prevPipeAtt, 'Pipeline attainment', `${Math.round(prevPipeAtt)}% → ${Math.round(pA)}%`, 'Pipeline attainment % vs pro-rated Q1 target, compared to last week');
  const saoArrow = kpiArrow(sA, prevSaoAtt, 'SAO attainment', `${Math.round(prevSaoAtt)}% → ${Math.round(sA)}%`, 'SAO attainment % vs pro-rated Q1 target, compared to last week');
  const sdrsArrow = kpiArrow(active, PREV_WEEK.activeSDRs, 'Active SDRs', `${PREV_WEEK.activeSDRs} → ${active}`, 'Change in number of active SDRs', 0);
  const avgArrow = kpiArrow(avgPctOfTarget, prevAvgPct, 'Avg pipeline pace', `${Math.round(prevAvgPct)}% → ${Math.round(avgPctOfTarget)}%`, 'Average pipeline per SDR as % of pro-rated €430k target', 2);
  const medArrow = kpiArrow(med, prevMed, 'Median activity', `${prevMed} → ${med}`, 'Median single-week Salesloft activity count', 2);
  const onTArrow = kpiArrow(curOnTrackPct, prevOnTrackPct, 'On-track rate', `${Math.round(prevOnTrackPct)}% → ${Math.round(curOnTrackPct)}%`, '% of SDRs at ≥75% SAO attainment', 2);

  document.getElementById('globalKpis').innerHTML = `
    <div class="kpi ${pA>=90?'green':pA>=70?'amber':'red'}"><div class="kpi-arrow">${pipeArrow}</div><div class="kpi-label">Pipeline</div><div class="kpi-value">${eurShort(totalPipe)}</div><div class="kpi-target">of ${eurShort(totalPipePR)} target</div><div class="kpi-delta ${pA>=90?'up':pA>=70?'amber':'down'}">${pct(pA)} attainment</div></div>
    <div class="kpi ${sA>=90?'green':sA>=70?'amber':'red'}"><div class="kpi-arrow">${saoArrow}</div><div class="kpi-label">SAO</div><div class="kpi-value">${totalSAO}</div><div class="kpi-target">of ${totalSaoPR} target</div><div class="kpi-delta ${sA>=90?'up':sA>=70?'amber':'down'}">${pct(sA)} attainment</div></div>
    <div class="kpi ${active>=43?'green':active>=35?'amber':'red'}"><div class="kpi-arrow">${sdrsArrow}</div><div class="kpi-label">Active SDRs</div><div class="kpi-value">${active}</div><div class="kpi-target">of 43 target headcount</div><div class="kpi-delta ${active>=43?'up':active>=35?'amber':'down'}">${pct(active/43*100)} staffed</div></div>
    <div class="kpi ${avgPctOfTarget>=90?'green':avgPctOfTarget>=70?'amber':'red'}"><div class="kpi-arrow">${avgArrow}</div><div class="kpi-label">Avg Pipe. / SDR</div><div class="kpi-value">${eurShort(Math.round(avgP))}</div><div class="kpi-target">of ${eurShort(Math.round(proRatedTarget))} target (€430k/qtr)</div><div class="kpi-delta ${avgPctOfTarget>=90?'up':avgPctOfTarget>=70?'amber':'down'}">${pct(avgPctOfTarget)} on-pace</div></div>
    <div class="kpi ${med>=500?'green':med>=350?'amber':'red'}"><div class="kpi-arrow">${medArrow}</div><div class="kpi-label">Median Act. / Wk</div><div class="kpi-value">${med}</div><div class="kpi-target">of 500 target</div><div class="kpi-delta ${med>=500?'up':med>=350?'amber':'down'}">${pct(med/500*100)} of target</div></div>
    <div class="kpi ${oR>=50?'green':'amber'}"><div class="kpi-arrow">${onTArrow}</div><div class="kpi-label">On-track SAO</div><div class="kpi-value">${onT} / ${SDRS.length}</div><div class="kpi-target">≥75% SAO attainment</div><div class="kpi-delta ${oR>=50?'up':'amber'}">${pct(oR)} on-track</div></div>`;
}

// ============================================================
// 2. WEEK-ON-WEEK CHANGES
// ============================================================
function renderWoW() {
  const snap = snapshotTotal('GLOBAL');
  const cur = { totalPipe: snap.pipe, totalSAOs: snap.saos, totalActs: SDRS.reduce((s,d)=>s+(d.acts||0),0), onTrack: SDRS.filter(s=>s.onTrack).length };
  const prev = PREV_WEEK;
  const dPipe = cur.totalPipe - prev.totalPipe;
  const dSAO = cur.totalSAOs - prev.totalSAOs;
  const dOnT = cur.onTrack - prev.onTrack;

  const nW = WEEK_HISTORY.length;
  const weeklyPipe = [], weeklySAO = [];
  for (let i = 0; i < nW; i++) {
    const w = WEEK_HISTORY[i]; const buKeys = ALL_BUS;
    const wPipe = buKeys.reduce((s,b) => s + ((w[b]||{}).pipe||0), 0);
    const wSao = buKeys.reduce((s,b) => s + ((w[b]||{}).saos||0), 0);
    if (i === 0) { weeklyPipe.push(wPipe); weeklySAO.push(wSao); }
    else {
      const p = WEEK_HISTORY[i-1];
      weeklyPipe.push(wPipe - buKeys.reduce((s,b) => s + ((p[b]||{}).pipe||0), 0));
      weeklySAO.push(wSao - buKeys.reduce((s,b) => s + ((p[b]||{}).saos||0), 0));
    }
  }
  const thisWkPipe = weeklyPipe[nW-1]||0, thisWkSao = weeklySAO[nW-1]||0;
  const priorPipeAvg = nW > 1 ? weeklyPipe.slice(0,-1).reduce((s,v) => s+v,0)/(nW-1) : thisWkPipe;
  const priorSaoAvg = nW > 1 ? weeklySAO.slice(0,-1).reduce((s,v) => s+v,0)/(nW-1) : thisWkSao;

  function wowTrendArrow(thisWk, priorAvg, label) {
    const p = priorAvg > 0 ? ((thisWk - priorAvg) / priorAvg) * 100 : 0;
    const dir = p > 10 ? 'up' : p < -10 ? 'down' : 'flat';
    const sym = p > 10 ? '▲' : p < -10 ? '▼' : '▶';
    return `<span class="trend-tag ${dir}" style="font-size:9px;padding:1px 5px" title="${label}: ${Math.round(p)}% vs avg">${sym}</span>`;
  }

  const median = arr => { const s = [...arr].sort((a,b)=>a-b); const m = Math.floor(s.length/2); return s.length%2 ? s[m] : Math.round((s[m-1]+s[m])/2); };
  const lwActs = SDRS.map(s => LAST_WEEK_ACTS[s.name] || 0);
  const medLW = median(lwActs);
  const priorMeds = [];
  for (let wi = 0; wi < nW - 1; wi++) {
    const wkActs = SDRS.map(s => { const h = SDR_ACT_HISTORY[s.name]; return h && h.length > wi ? h[wi] : 0; });
    priorMeds.push(median(wkActs));
  }
  const priorMedAvg = priorMeds.length > 0 ? priorMeds.reduce((s,v)=>s+v,0)/priorMeds.length : medLW;
  const janWeekly = SDRS.map(s => { const lw = LAST_WEEK_ACTS[s.name]||0; return Math.round(Math.max(0,(s.acts||0)-lw)/4); });
  const medJan = median(janWeekly);
  const dMed = medLW - medJan;

  document.getElementById('wowSub').textContent = 'Comparing Week 6 vs Week 5 (ending 5 Feb)';
  document.getElementById('wowGrid').innerHTML = `
    <div class="wow-card" style="position:relative">
      <div style="position:absolute;top:10px;right:10px">${wowTrendArrow(thisWkPipe, priorPipeAvg, 'Pipeline this week')}<span class="zone-tip" data-tip="New pipeline created this week vs the average weekly pipeline from prior weeks. Arrow shows if this week is above, below, or in line with the trend.">?</span></div>
      <div class="wow-card-title">Pipeline Added This Week</div>
      <div class="wow-main" style="color:${dPipe>=0?'#16a34a':'#dc2626'}">${dPipe>=0?'+':''}${eurShort(dPipe)}</div>
      <div class="wow-detail">Cumulative now ${eurShort(cur.totalPipe)}</div>
      <div class="wow-tag ${dPipe>=0?'pos':'neg'}">${eurShort(dPipe)} in the week</div>
    </div>
    <div class="wow-card" style="position:relative">
      <div style="position:absolute;top:10px;right:10px">${wowTrendArrow(thisWkSao, priorSaoAvg, 'SAOs this week')}<span class="zone-tip" data-tip="Sales Accepted Opportunities created this week vs the average weekly SAO count from prior weeks. Arrow shows weekly momentum.">?</span></div>
      <div class="wow-card-title">SAO Closed This Week</div>
      <div class="wow-main" style="color:${dSAO>=0?'#16a34a':'#dc2626'}">+${dSAO}</div>
      <div class="wow-detail">Cumulative now ${cur.totalSAOs}</div>
      <div class="wow-tag ${dSAO>=40?'pos':dSAO>=30?'neu':'neg'}">${dSAO >= 40 ? 'Strong week' : dSAO >= 30 ? 'Steady' : 'Below run-rate'}</div>
    </div>
    <div class="wow-card" style="position:relative">
      <div style="position:absolute;top:10px;right:10px">${wowTrendArrow(cur.onTrack, prev.onTrack, 'On-track SDRs')}<span class="zone-tip" data-tip="Number of SDRs at or above 75% of their individual pro-rated SAO target. Change shown vs previous week.">?</span></div>
      <div class="wow-card-title">On-track SDRs (≥75% SAO)</div>
      <div class="wow-main">${cur.onTrack} <span style="font-size:14px;color:${dOnT>=0?'#16a34a':'#dc2626'}">(${dOnT>=0?'+':''}${dOnT})</span></div>
      <div class="wow-detail">${SDRS.length - cur.onTrack} off-track entering next week</div>
      <div class="wow-tag ${dOnT>0?'pos':dOnT===0?'neu':'neg'}">${dOnT>0?'Improving':dOnT===0?'No change':'Slipping'}</div>
    </div>
    <div class="wow-card" style="position:relative">
      <div style="position:absolute;top:10px;right:10px">${wowTrendArrow(medLW, priorMedAvg, 'Median activity')}<span class="zone-tip" data-tip="Median single-week Salesloft activity count across all SDRs, compared to the average median from prior weeks. Target is 500 activities per week.">?</span></div>
      <div class="wow-card-title">Median Activities / Week</div>
      <div class="wow-main">${medLW.toLocaleString()} <span style="font-size:14px;color:${dMed>=0?'#16a34a':'#dc2626'}">(${dMed>=0?'+':''}${dMed.toLocaleString()})</span></div>
      <div class="wow-detail">Jan avg median: ${medJan.toLocaleString()} / week</div>
      <div class="wow-tag ${medLW>=500?'pos':medLW>=350?'neu':'neg'}">${medLW>=500?'Above target':medLW>=350?'Building':'Below 500 target'}</div>
    </div>`;
}

// ============================================================
// 3. PIPELINE vs PRO-RATED TARGET BARS
// ============================================================
function renderPipeTargetBars() {
  // Regional definitions: BUs + inbound splits
  const regions = [
    { key:'GLOBAL', label:'Global', color:'#475569',
      getBU: () => ALL_BUS,
      getIB: () => null },
    { key:'DACH', label:'DACH', color:'#0F4C81', subLabel:'Corp + ENT',
      getBU: () => ['DACH_ENT_OB','DACH_CORP_OB'],
      getIB: () => 'IB_DACH' },
    { key:'EMEA', label:'Rest of EMEA', color:'#F18F01',
      getBU: () => ['EMEA_OB'],
      getIB: () => 'IB_EMEA' },
    { key:'INBOUND', label:'Inbound (EMEA/DACH)', color:'#64748b',
      getBU: () => ['INBOUND'],
      getIB: () => null },
    { key:'AMER', label:'AMER', color:'#7B2D8E',
      getBU: () => ['AMER_OB'],
      getIB: () => null },
    { key:'APJ', label:'APJ', color:'#C73E1D',
      getBU: () => ['APJ_OB'],
      getIB: () => null },
  ];

  // Compute pipeline and quarterly target for each region
  const d = new Date(WEEK.ending + 'T00:00:00');
  const month = d.getMonth(), day = d.getDate();
  const daysInMonth = new Date(d.getFullYear(), month + 1, 0).getDate();

  function proRateTarget(t) {
    if (month === 0)      return Math.round((day / daysInMonth) * t.jan);
    else if (month === 1) return Math.round(t.jan + (day / daysInMonth) * t.feb);
    else                  return Math.round(t.jan + t.feb + (day / daysInMonth) * t.mar);
  }

  function quarterTotal(t) { return t.jan + t.feb + t.mar; }

  const bars = regions.map(reg => {
    // Actual pipeline from WEEK_HISTORY snapshot (current and previous)
    let actualPipe = 0, prevPipe = 0;
    const prevSnap = WEEK_HISTORY.length >= 2 ? WEEK_HISTORY[WEEK_HISTORY.length - 2] : null;

    if (reg.key === 'GLOBAL') {
      actualPipe = ALL_BUS.reduce((s,bu) => s + (SNAPSHOT_LATEST[bu]?SNAPSHOT_LATEST[bu].pipe:0), 0);
      if (prevSnap) prevPipe = ALL_BUS.reduce((s,bu) => s + (prevSnap[bu]?prevSnap[bu].pipe:0), 0);
    } else if (reg.key === 'INBOUND') {
      actualPipe = SNAPSHOT_LATEST.INBOUND ? SNAPSHOT_LATEST.INBOUND.pipe : 0;
      if (prevSnap) prevPipe = prevSnap.INBOUND ? prevSnap.INBOUND.pipe : 0;
    } else {
      reg.getBU().forEach(bu => { actualPipe += (SNAPSHOT_LATEST[bu]?SNAPSHOT_LATEST[bu].pipe:0); });
      const ibKey = reg.getIB();
      if (ibKey && SNAPSHOT_LATEST[ibKey]) actualPipe += SNAPSHOT_LATEST[ibKey].pipe;
      if (prevSnap) {
        reg.getBU().forEach(bu => { prevPipe += (prevSnap[bu]?prevSnap[bu].pipe:0); });
        if (ibKey && prevSnap[ibKey]) prevPipe += prevSnap[ibKey].pipe;
      }
    }

    // Pro-rated target from SDR roster allocation (current week and previous week)
    let proRated = 0, prevProRated = 0, q1Total = 0;

    // Previous week ending date for pro-rating
    const prevEnd = WEEK_HISTORY.length >= 2 ? WEEKS_DEF[WEEK_HISTORY.length - 2].ending : null;
    const pd = prevEnd ? new Date(prevEnd + 'T00:00:00') : null;
    const pMonth = pd ? pd.getMonth() : 0;
    const pDay = pd ? pd.getDate() : 0;
    const pDIM = pd ? new Date(pd.getFullYear(), pMonth + 1, 0).getDate() : 31;

    function prevProRate(t) {
      if (!pd) return 0;
      if (pMonth === 0)      return Math.round((pDay / pDIM) * t.jan);
      else if (pMonth === 1) return Math.round(t.jan + (pDay / pDIM) * t.feb);
      else                   return Math.round(t.jan + t.feb + (pDay / pDIM) * t.mar);
    }

    Object.entries(SDR_ROSTER).forEach(([name, r]) => {
      const t = MONTHLY_PIPE_TARGETS[name];
      if (!t) return;
      let include = false;
      if (reg.key === 'GLOBAL') include = true;
      else if (reg.key === 'INBOUND') include = r.bu === 'INBOUND';
      else if (reg.key === 'DACH') include = (r.region === 'DACH' && r.bu !== 'INBOUND');
      else if (reg.key === 'EMEA') include = (r.region === 'EMEA' && r.bu !== 'INBOUND');
      else if (reg.key === 'AMER') include = r.region === 'AMER';
      else if (reg.key === 'APJ') include = r.region === 'APJ';
      if (include) {
        proRated += proRateTarget(t);
        prevProRated += prevProRate(t);
        q1Total += quarterTotal(t);
      }
    });

    const attPct = proRated > 0 ? (actualPipe / proRated) * 100 : 0;
    const prevAttPct = prevProRated > 0 ? (prevPipe / prevProRated) * 100 : 0;
    return { ...reg, actualPipe, proRated, q1Total, attPct, prevAttPct };
  });

  // Determine max bar width (the bar fills proportional to target, fill proportional to actual)
  let html = `<div class="pipe-target-title">Pipeline vs Pro-rated Target (€)</div>`;
  html += `<div class="pipe-target-sub">Quarterly targets adjusted to ${(WE / WEEK.totalWeeks * 3).toFixed(2)} months (Jan full + ${Math.round(day / daysInMonth * 100)}% Feb)</div>`;

  bars.forEach((b, i) => {
    const isGlobal = b.key === 'GLOBAL';
    const fillPct = Math.min(b.attPct, 130); // cap visual at 130%
    const targetLinePct = 100 / 1.3; // 100% mark relative to 130% max
    const pctClass = b.attPct >= 90 ? 'green' : b.attPct >= 60 ? 'amber' : 'red';
    const targetLabel = b.proRated >= 1000000 ? '€' + (b.proRated/1000000).toFixed(1)+'M target' : '€' + Math.round(b.proRated/1000)+'k target';
    const actualLabel = b.actualPipe >= 1000000 ? '€' + (b.actualPipe/1000000).toFixed(1)+'M' : '€' + Math.round(b.actualPipe/1000)+'k';

    // WoW direction arrow
    const attDelta = b.attPct - b.prevAttPct;
    const arrowDir = attDelta > 2 ? 'up' : attDelta < -2 ? 'down' : 'flat';
    const arrowSym = attDelta > 2 ? '▲' : attDelta < -2 ? '▼' : '▶';
    const arrowMove = attDelta > 2 ? 'Gaining ground' : attDelta < -2 ? 'Losing ground' : 'Holding steady';
    const arrowTip = `${b.label}: ${arrowMove} vs target. Attainment moved from ${Math.round(b.prevAttPct)}% last week to ${Math.round(b.attPct)}% this week (${attDelta >= 0 ? '+' : ''}${Math.round(attDelta)}pp).`;

    html += `<div class="pipe-bar-row${isGlobal ? ' global-row' : ''}">
      <div class="pipe-bar-label">
        <div class="pipe-bar-dot" style="background:${b.color}"></div>
        <div class="pipe-bar-name">${b.label}</div>
      </div>
      <div class="pipe-bar-value">${actualLabel}</div>
      <div class="pipe-bar-track">
        <div class="pipe-bar-fill" style="width:${fillPct / 1.3}%;background:${b.color}"></div>
        <div class="pipe-bar-target-line" style="left:${targetLinePct}%"></div>
      </div>
      <div class="pipe-bar-target-label">${targetLabel}</div>
      <div class="pipe-bar-pct ${pctClass}">${Math.round(b.attPct)}%</div>
      <div style="display:flex;align-items:center;gap:6px;justify-content:flex-end;margin-left:4px"><span class="trend-tag ${arrowDir}" style="font-size:9px;padding:1px 5px">${arrowSym}</span><span class="zone-tip" data-tip="${arrowTip}">?</span></div>
    </div>`;
  });

  // Footer with quarterly targets
  const qLabels = bars.filter(b => b.key !== 'GLOBAL').map(b => {
    const label = b.key === 'INBOUND' ? 'Inbound' : b.key;
    return `${label} €${(b.q1Total/1000000).toFixed(2)}M`;
  });
  html += `<div class="pipe-bar-footer">Each bar shows attainment relative to that region's pro-rated target (vertical line = 100%). Quarterly targets: ${qLabels.join(', ')}.</div>`;

  document.getElementById('pipeTargetBars').innerHTML = html;
}

// ============================================================
// 4. PIPELINE TREND CHART
// ============================================================
function computeTargetCurve(filter, metric) {
  const sdrs = Object.entries(SDR_ROSTER).filter(([name, r]) => {
    if (filter === 'GLOBAL') return true;
    if (filter.startsWith('R_')) return r.region === filter.slice(2);
    return r.bu === filter;
  }).map(([name]) => name);

  const table = metric === 'pipe' ? MONTHLY_PIPE_TARGETS : MONTHLY_SAO_TARGETS;
  const useSaoDay = metric === 'saos';

  return WEEKS_DEF.map(w => {
    const d = new Date(w.ending + 'T00:00:00');
    const month = d.getMonth(), day = d.getDate();
    const dims = [31, 28, 31], dim = dims[month];
    const useDay = useSaoDay ? Math.min(day + 2, dim) : day;
    let total = 0;
    sdrs.forEach(name => {
      const t = table[name] || { jan:0, feb:0, mar:0 };
      if (month === 0)      total += Math.round((useDay / dim) * t.jan);
      else if (month === 1) total += Math.round(t.jan + (useDay / dim) * t.feb);
      else                  total += Math.round(t.jan + t.feb + (useDay / dim) * t.mar);
    });
    return total;
  });
}

function getActualsCurve(filter, metric) {
  const bus = ALL_BUS;
  const regionMap = {
    R_DACH: (w) => (w.DACH_ENT_OB||{})[metric] + (w.DACH_CORP_OB||{})[metric] + (w.IB_DACH||{})[metric],
    R_EMEA: (w) => (w.EMEA_OB||{})[metric] + (w.IB_EMEA||{})[metric],
    R_AMER: (w) => (w.AMER_OB||{})[metric],
    R_APJ:  (w) => (w.APJ_OB||{})[metric],
  };
  return WEEK_HISTORY.map(w => {
    if (filter === 'GLOBAL') return bus.reduce((s, bu) => s + ((w[bu]||{})[metric]||0), 0);
    if (regionMap[filter]) return regionMap[filter](w) || 0;
    return ((w[filter]||{})[metric]) || 0;
  });
}

function computeProjections(actuals, targets) {
  const nData = WEEK_HISTORY.length;
  if (nData < 2) return null;
  const lastVal = actuals[nData - 1];
  const totalWeeks = 13, remaining = totalWeeks - nData;
  if (remaining <= 0) return null;

  const increments = [];
  for (let i = 0; i < nData; i++) increments.push(i === 0 ? actuals[0] : actuals[i] - actuals[i-1]);
  const recentN = Math.min(3, nData);
  const paceWeekly = increments.slice(-recentN).reduce((s,v) => s+v, 0) / recentN;
  const mean = increments.reduce((s,v) => s+v, 0) / nData;
  const variance = increments.reduce((s,v) => s + (v-mean)**2, 0) / nData;
  const stdDev = Math.sqrt(variance);
  const q1Target = targets ? targets[totalWeeks - 1] : 0;
  const requiredWeekly = remaining > 0 ? (q1Target - lastVal) / remaining : 0;

  const pace = [], upper = [], lower = [], required = [];
  for (let w = 0; w < remaining; w++) {
    const n = w + 1;
    pace.push(Math.round(lastVal + paceWeekly * n));
    upper.push(Math.round(lastVal + (paceWeekly + stdDev * 1.5) * n));
    lower.push(Math.max(Math.round(lastVal + (paceWeekly - stdDev / 3) * n), Math.round(lastVal)));
    required.push(Math.round(lastVal + requiredWeekly * n));
  }
  return { startWeek: nData, pace, upper, lower, required, paceWeekly: Math.round(paceWeekly), requiredWeekly: Math.round(requiredWeekly), stdDev: Math.round(stdDev), q1Target: Math.round(q1Target), remaining };
}

function renderTrendCallout() {
  const pipeTargets = computeTargetCurve('GLOBAL', 'pipe');
  const pipeActuals = getActualsCurve('GLOBAL', 'pipe');
  const proj = computeProjections(pipeActuals, pipeTargets);
  if (!proj) return;

  const nData = WEEK_HISTORY.length;
  const lastPipe = pipeActuals[nData - 1];
  const pipeLand = proj.pace[proj.pace.length - 1];
  const pipeLandPct = proj.q1Target > 0 ? Math.round(pipeLand / proj.q1Target * 100) : 0;
  const pipeGap = Math.max(0, proj.q1Target - lastPipe);
  const pipeRatio = proj.paceWeekly > 0 ? (proj.requiredWeekly / proj.paceWeekly * 100) : 0;

  const pipeIncs = [];
  for (let i = 0; i < nData; i++) pipeIncs.push(i === 0 ? pipeActuals[0] : pipeActuals[i] - pipeActuals[i-1]);
  const early3 = pipeIncs.slice(0, Math.min(3, nData));
  const recent3 = pipeIncs.slice(-Math.min(3, nData));
  const earlyAvg = early3.reduce((s,v) => s+v, 0) / early3.length;
  const recentAvg = recent3.reduce((s,v) => s+v, 0) / recent3.length;
  const accelPct = earlyAvg > 0 ? Math.round((recentAvg / earlyAvg) * 100) : 100;

  const onPace = pipeLandPct >= 95;
  const landClass = pipeLandPct >= 95 ? 'green' : pipeLandPct >= 75 ? 'amber' : 'red';
  const accelClass = accelPct >= 115 ? 'green' : accelPct >= 90 ? 'amber' : 'red';
  const accelLabel = accelPct >= 115 ? 'Accelerating' : accelPct >= 90 ? 'Steady' : 'Slowing';

  const totalSAOs = snapshotTotal('GLOBAL').saos;
  const avgDeal = totalSAOs > 0 ? Math.round(lastPipe / totalSAOs) : 0;

  // Required deal size: Q1 pipeline target ÷ Q1 SAO target
  const saoTargets = computeTargetCurve('GLOBAL', 'sao');
  const q1SaoTarget = saoTargets ? saoTargets[saoTargets.length - 1] : 0;
  const reqDeal = q1SaoTarget > 0 ? Math.round(proj.q1Target / q1SaoTarget) : 0;
  const dealDelta = reqDeal > 0 ? Math.round((avgDeal / reqDeal) * 100) : 0;
  const dealDeltaClass = dealDelta >= 100 ? 'up' : dealDelta >= 80 ? 'amber' : 'down';
  const fmtFull = v => '€' + v.toLocaleString();

  const fmtK = v => v >= 1000000 ? '€' + (v/1000000).toFixed(1)+'M' : '€' + Math.round(v/1000)+'k';

  const bgColor = onPace ? '#f0fdf4' : '#f8fafc';
  const bdColor = onPace ? '#bbf7d0' : '#e2e8f0';

  const rampCount = SDRS.filter(s => s.type === 'Ramp').length;
  const hcGap = Math.max(0, 43 - SDRS.length);

  const lines = [];
  if (onPace) lines.push('Current pace projects to meet or exceed pipeline target without further changes.');
  else lines.push('The projection range assumes no changes to the current team. It is a baseline, not a forecast.');
  if (hcGap > 0) lines.push(hcGap + ' additional hires planned against 43 target headcount (' + SDRS.length + ' active today). Each new SDR adds incremental pipeline capacity as they ramp.');
  if (rampCount > 0) lines.push(rampCount + ' of ' + SDRS.length + ' SDRs currently on ramp quotas. As they reach full quota, pipeline output will step up beyond the current pace line.');
  if (!onPace) lines.push('Required pace is ' + Math.round(pipeRatio) + '% of current output. Closing the gap depends on deal-value accuracy, prospecting into higher-value segments, and new hires ramping in.');

  document.getElementById('trendCallout').innerHTML = `
    <div class="kpi-row" style="grid-template-columns:repeat(6,1fr);margin-bottom:10px">
      <div class="kpi blue" style="position:relative"><span class="zone-tip" data-tip="The weekly pipeline creation needed to reach the full Q1 target from the current cumulative total, spread evenly across the remaining weeks." style="position:absolute;top:14px;right:10px">?</span><div class="kpi-label">Required / Wk</div><div class="kpi-value" style="font-size:22px">${fmtK(proj.requiredWeekly)}</div><div class="kpi-target">to hit ${fmtK(proj.q1Target)} in ${proj.remaining} wks</div></div>
      <div class="kpi green" style="position:relative"><span class="zone-tip" data-tip="Average weekly pipeline created over the last 3 weeks. The range shows the confidence band based on weekly variance (downside conservative, upside reflects ramp potential)." style="position:absolute;top:14px;right:10px">?</span><div class="kpi-label">Current Pace</div><div class="kpi-value" style="font-size:22px">${fmtK(proj.paceWeekly)}</div><div class="kpi-target">per week average</div><div class="kpi-delta flat" style="font-size:10px">${fmtK(Math.round(proj.paceWeekly - proj.stdDev/3))}–${fmtK(Math.round(proj.paceWeekly + proj.stdDev*1.5))} range</div></div>
      <div class="kpi ${pipeGap===0?'green':'amber'}" style="position:relative"><span class="zone-tip" data-tip="The difference between the Q1 quarterly pipeline target and cumulative pipeline created to date. This is the total amount still to be generated." style="position:absolute;top:14px;right:10px">?</span><div class="kpi-label">Gap</div><div class="kpi-value" style="font-size:22px">${fmtK(pipeGap)}</div><div class="kpi-target">remaining to Q1 target</div></div>
      <div class="kpi ${landClass}" style="position:relative"><span class="zone-tip" data-tip="Projected total pipeline at quarter end if the current 3-week average pace continues unchanged. Shown as a percentage of the Q1 target." style="position:absolute;top:14px;right:10px">?</span><div class="kpi-label">Forecast Landing</div><div class="kpi-value" style="font-size:22px">${fmtK(pipeLand)}</div><div class="kpi-target">at current pace</div><div class="kpi-delta ${landClass==='green'?'up':landClass==='amber'?'amber':'down'}" style="font-size:10px">${pipeLandPct}% of target</div></div>
      <div class="kpi ${avgDeal>0?'purple':'grey'}" style="position:relative"><span class="zone-tip" data-tip="Total cumulative pipeline divided by total SAOs created. The required deal size is calculated from the Q1 pipeline target divided by Q1 SAO target. Compares whether actual deal values are tracking above or below what is needed." style="position:absolute;top:14px;right:10px">?</span><div class="kpi-label">Avg Deal Size</div><div class="kpi-value" style="font-size:22px">${avgDeal > 0 ? fmtFull(avgDeal) : '—'}</div><div class="kpi-target">pipeline ÷ SAOs</div>${reqDeal > 0 ? `<div class="kpi-delta ${dealDeltaClass}" style="font-size:10px">${dealDelta}% of ${fmtFull(reqDeal)} required</div>` : ''}</div>
      <div class="kpi ${accelClass}" style="position:relative"><span class="zone-tip" data-tip="Compares recent weekly pipeline output (last 3 weeks) against earlier weeks (first 3 weeks). Positive means the team is creating more pipeline per week as the quarter progresses." style="position:absolute;top:14px;right:10px">?</span><div class="kpi-label">Acceleration</div><div class="kpi-value" style="font-size:22px">${nData >= 4 ? accelPct+'%' : '—'}</div><div class="kpi-target">${nData >= 4 ? accelLabel : 'Need 4+ weeks'}</div></div>
    </div>
    <div style="background:${bgColor};border:1px solid ${bdColor};border-radius:10px;padding:14px 18px">
      <div style="font-size:10px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">${onPace?'✅ ':''}Pipeline Outlook</div>
      <div style="font-size:12px;color:#334155;line-height:1.6">${lines.join('<br style="margin-bottom:4px">')}</div>
    </div>`;
}

function renderTrendChart() {
  const targets = computeTargetCurve('GLOBAL', 'pipe');
  const actuals = getActualsCurve('GLOBAL', 'pipe');
  const proj = computeProjections(actuals, targets);

  document.getElementById('trendTitle').textContent = 'Pipeline Trend — Global';
  const canvas = document.getElementById('trendCanvas');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
  canvas.style.width = rect.width + 'px'; canvas.style.height = rect.height + 'px';
  const ctx = canvas.getContext('2d'); ctx.scale(dpr, dpr);

  const W = rect.width, H = rect.height;
  const pL = 80, pR = 75, pT = 46, pB = 50;
  const pW = W - pL - pR, pH = H - pT - pB;

  let allVals = [...targets, ...actuals];
  if (proj) allVals.push(...proj.upper, ...proj.lower, ...proj.pace, ...proj.required);
  const maxVal = Math.max(...allVals) * 1.15 || 1;
  const numWeeks = 13;
  const xStep = pW / (numWeeks - 1);

  // Grid lines
  ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 0.5;
  for (let i = 0; i <= 5; i++) {
    const y = pT + pH - (i / 5) * pH;
    ctx.beginPath(); ctx.moveTo(pL, y); ctx.lineTo(pL + pW, y); ctx.stroke();
    ctx.fillStyle = '#94a3b8'; ctx.font = "500 9px 'DM Sans'"; ctx.textAlign = 'right';
    const val = (maxVal / 5) * i;
    ctx.fillText('€' + (val >= 1000000 ? (val/1000000).toFixed(1)+'M' : Math.round(val/1000)+'k'), pL - 8, y + 3);
  }

  // Month dividers
  const monthWeeks = [{ label:'January', start:0, end:3 }, { label:'February', start:4, end:7 }, { label:'March', start:8, end:12 }];
  monthWeeks.forEach(m => {
    if (m.start > 0) {
      const mx = pL + (m.start - 0.5) * xStep;
      ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 1; ctx.setLineDash([4,4]);
      ctx.beginPath(); ctx.moveTo(mx, pT); ctx.lineTo(mx, pT + pH); ctx.stroke();
      ctx.setLineDash([]);
    }
    const midX = pL + ((m.start + m.end) / 2) * xStep;
    ctx.fillStyle = '#94a3b8'; ctx.font = "600 10px 'DM Sans'"; ctx.textAlign = 'center';
    ctx.fillText(m.label, midX, pT + pH + 38);
  });

  // X axis labels
  for (let i = 0; i < numWeeks; i++) {
    ctx.fillStyle = '#94a3b8'; ctx.font = "500 9px 'DM Sans'"; ctx.textAlign = 'center';
    ctx.fillText('W' + (i+1), pL + i * xStep, pT + pH + 16);
  }

  // Target curve
  ctx.strokeStyle = '#0F4C81'; ctx.lineWidth = 2; ctx.setLineDash([6,4]); ctx.globalAlpha = 0.5;
  ctx.beginPath();
  targets.forEach((v, i) => { const x = pL + i * xStep, y = pT + pH - (v/maxVal)*pH; i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y); });
  ctx.stroke(); ctx.setLineDash([]); ctx.globalAlpha = 1;
  const lastTarget = targets[targets.length-1];
  ctx.fillStyle = '#0F4C81'; ctx.font = "bold 9px 'DM Sans'"; ctx.textAlign = 'right';
  ctx.fillText('€' + (lastTarget >= 1000000 ? (lastTarget/1000000).toFixed(1)+'M' : Math.round(lastTarget/1000)+'k'), pL + (numWeeks-1)*xStep - 4, pT + pH - (lastTarget/maxVal)*pH - 6);

  // Actuals area + line
  ctx.fillStyle = 'rgba(22, 163, 74, 0.06)'; ctx.beginPath(); ctx.moveTo(pL, pT + pH);
  actuals.forEach((v, i) => { if (i >= WEEK_HISTORY.length) return; ctx.lineTo(pL + i*xStep, pT + pH - (v/maxVal)*pH); });
  ctx.lineTo(pL + (WEEK_HISTORY.length-1)*xStep, pT + pH); ctx.closePath(); ctx.fill();

  ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 2.5; ctx.beginPath();
  actuals.forEach((v, i) => { if (i >= WEEK_HISTORY.length) return; const x = pL + i*xStep, y = pT + pH - (v/maxVal)*pH; i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y); });
  ctx.stroke();

  actuals.forEach((v, i) => {
    if (i >= WEEK_HISTORY.length) return;
    const x = pL + i*xStep, y = pT + pH - (v/maxVal)*pH;
    ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = '#16a34a'; ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
  });

  // Latest value label
  const lastIdx = WEEK_HISTORY.length - 1;
  const lastVal = actuals[lastIdx];
  const lx = pL + lastIdx * xStep, ly = pT + pH - (lastVal/maxVal)*pH;
  const labelX = lx - 60, labelY = ly + 40;
  ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 0.8; ctx.setLineDash([2,2]);
  ctx.beginPath(); ctx.moveTo(lx, ly+5); ctx.lineTo(labelX+52, labelY-12); ctx.stroke(); ctx.setLineDash([]);
  ctx.fillStyle = '#16a34a'; ctx.font = "bold 11px 'DM Sans'"; ctx.textAlign = 'right';
  ctx.fillText('€' + (lastVal >= 1000000 ? (lastVal/1000000).toFixed(1)+'M' : Math.round(lastVal/1000)+'k'), labelX+54, labelY-2);
  const targetAtWeek = targets[lastIdx] || 1;
  const attPct = Math.round((lastVal/targetAtWeek)*100);
  ctx.fillStyle = attPct >= 90 ? '#16a34a' : attPct >= 70 ? '#d97706' : '#dc2626';
  ctx.font = "bold 9px 'DM Sans'"; ctx.textAlign = 'right';
  ctx.fillText(attPct + '% of target', labelX+54, labelY+10);

  // Projections
  if (proj && WEEK_HISTORY.length >= 2) {
    const startIdx = proj.startWeek;
    const startX = pL + (startIdx-1)*xStep;
    const startY = pT + pH - (actuals[startIdx-1]/maxVal)*pH;

    function drawProj(data, color, dash, lw) {
      ctx.strokeStyle = color; ctx.lineWidth = lw; ctx.setLineDash(dash); ctx.globalAlpha = 0.7;
      ctx.beginPath(); ctx.moveTo(startX, startY);
      data.forEach((v, i) => ctx.lineTo(pL + (startIdx+i)*xStep, pT + pH - (v/maxVal)*pH));
      ctx.stroke(); ctx.setLineDash([]); ctx.globalAlpha = 1;
    }

    // Confidence band
    ctx.fillStyle = 'rgba(22, 163, 74, 0.07)'; ctx.beginPath(); ctx.moveTo(startX, startY);
    proj.upper.forEach((v, i) => ctx.lineTo(pL + (startIdx+i)*xStep, pT + pH - (v/maxVal)*pH));
    for (let i = proj.lower.length-1; i >= 0; i--) ctx.lineTo(pL + (startIdx+i)*xStep, pT + pH - (proj.lower[i]/maxVal)*pH);
    ctx.closePath(); ctx.fill();

    drawProj(proj.upper, '#16a34a', [2,3], 0.8);
    drawProj(proj.lower, '#16a34a', [2,3], 0.8);
    drawProj(proj.required, '#0F4C81', [], 2.5);
    drawProj(proj.pace, '#16a34a', [6,4], 1.8);

    const endX = pL + (numWeeks-1)*xStep;
    const fmtVal = v => '€' + (v >= 1000000 ? (v/1000000).toFixed(1)+'M' : Math.round(v/1000)+'k');
    const labels = [
      { y: pT + pH - (proj.required[proj.required.length-1]/maxVal)*pH, color:'#0F4C81', label: fmtVal(proj.required[proj.required.length-1])+' req', bold:true },
      { y: pT + pH - (proj.pace[proj.pace.length-1]/maxVal)*pH, color:'#16a34a', label: fmtVal(proj.pace[proj.pace.length-1])+' pace', bold:false },
    ].sort((a,b) => a.y - b.y);
    for (let i = 1; i < labels.length; i++) { if (labels[i].y - labels[i-1].y < 14) labels[i].y = labels[i-1].y + 14; }
    labels.forEach(lp => { ctx.fillStyle = lp.color; ctx.font = (lp.bold ? "bold 10px" : "500 9px") + " 'DM Sans'"; ctx.textAlign = 'left'; ctx.fillText(lp.label, endX+6, lp.y+3); });
  }

  // Legend
  const legY = pT - 24; let lo = pL;
  ctx.setLineDash([6,4]); ctx.strokeStyle = '#0F4C81'; ctx.lineWidth = 2; ctx.globalAlpha = 0.5;
  ctx.beginPath(); ctx.moveTo(lo, legY); ctx.lineTo(lo+30, legY); ctx.stroke(); ctx.setLineDash([]); ctx.globalAlpha = 1;
  ctx.fillStyle = '#64748b'; ctx.font = "500 10px 'DM Sans'"; ctx.textAlign = 'left'; ctx.fillText('Target', lo+34, legY+3); lo += 85;
  ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 2.5; ctx.beginPath(); ctx.moveTo(lo, legY); ctx.lineTo(lo+30, legY); ctx.stroke();
  ctx.fillStyle = '#16a34a'; ctx.beginPath(); ctx.arc(lo+15, legY, 3, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#64748b'; ctx.font = "500 10px 'DM Sans'"; ctx.fillText('Actual', lo+34, legY+3); lo += 80;
  if (proj) {
    ctx.strokeStyle = '#0F4C81'; ctx.lineWidth = 2.5; ctx.beginPath(); ctx.moveTo(lo, legY); ctx.lineTo(lo+25, legY); ctx.stroke();
    ctx.fillStyle = '#64748b'; ctx.font = "600 10px 'DM Sans'"; ctx.fillText('Required Pace', lo+29, legY+3); lo += 120;
    ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 1.8; ctx.setLineDash([6,4]); ctx.beginPath(); ctx.moveTo(lo, legY); ctx.lineTo(lo+25, legY); ctx.stroke(); ctx.setLineDash([]);
    ctx.fillStyle = '#64748b'; ctx.font = "500 10px 'DM Sans'"; ctx.fillText('Current Pace', lo+29, legY+3); lo += 108;
    ctx.fillStyle = 'rgba(22, 163, 74, 0.15)'; ctx.fillRect(lo, legY-5, 25, 10);
    ctx.fillStyle = '#64748b'; ctx.font = "500 10px 'DM Sans'"; ctx.fillText('Range', lo+29, legY+3);
  }
  ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(pL, pT+pH); ctx.lineTo(pL+pW, pT+pH); ctx.stroke();
}

// ============================================================
// INIT
// ============================================================
renderGlobalKPIs();
renderWoW();
renderPipeTargetBars();
renderTrendCallout();
renderTrendChart();
</script>
</body>
</html>
